<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>QSA Documentation</title>
        <meta name="robots" content="noindex">


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="custom.css">


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">QSA Documentation</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/pblottiere/QSA" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <p>Welcome to QGIS Server Administration tool’s documentation.</p>
<p><a href="https://docs.qgis.org/3.34/en/docs/server_manual/introduction.html">QGIS Server</a> is
a map-server based on the QGIS core library and rendering engine which provides
numerous classical services like WMS, WFS, WCS, WMTS and OGC API Features.
While QGIS Desktop acts like a WYSIWYG tool for setting up projects, the need
for a REST API is sometime necessary to configure and administrate QGIS Server: custom web client, cloud deployment, …. The aim of the QSA project is to
provide such an API and tools.</p>
<p>Components:</p>
<ul>
<li><a href="qsa-api/">QSA REST API</a>: Flask web server with a REST API for administrating QGIS Server</li>
<li><a href="qsa-plugin/">QSA plugin</a>: QGIS Server plugin for introspection</li>
<li><a href="qsa-cli/">QSA cli</a>: Command line tool</li>
</ul>
<p>Features:</p>
<ul>
<li>Create and manage QGIS projects stored on the filesystem or in PostgreSQL</li>
<li>Create and update vector and raster layers : symbology, theme, …</li>
<li>Inspect online QGIS Server instances</li>
<li>Optional cache management with MapProxy</li>
</ul>
<p><img src="images/qsa_archi.png" alt="QSA" /></p>
<p>Roadmap:</p>
<ul>
<li>Add more documentation</li>
<li>Add PostgreSQL support to store QGIS styles and QSA internals data</li>
<li>Publish <code>qsa-cli</code> on PyPI</li>
<li>Publish <code>qsa-plugin</code> on QGIS plugin repository</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="qsa-rest-api"><a class="header" href="#qsa-rest-api">QSA REST API</a></h1>
<p><code>qsa-api</code> is a <a href="https://flask.palletsprojects.com/en/3.0.x/">Flask</a> WSGI server
providing a REST API for managing QGIS Server.</p>
<p>Features:</p>
<ul>
<li>Create and manage projects stored on the filesystem or in PostgreSQL</li>
<li>Add and update layers based on multiple datasources (AWS S3 buckets, …)</li>
<li>Configure symbology and themes based on simple symbols parameters</li>
</ul>
<p>Optional features:</p>
<ul>
<li>Interaction with online QGIS Server instances (depends on <a href="qsa-api/qsa-plugin/">QSA
plugin</a>)</li>
<li>Cache management with MapProxy</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="qsa-rest-api--installation"><a class="header" href="#qsa-rest-api--installation">QSA REST API : installation</a></h1>
<h2 id="from-sources"><a class="header" href="#from-sources">From sources</a></h2>
<pre><code class="language-console">$ cd qsa-api
$ virtualenv --system-site-packages venv  # system aware for pyqgis
$ . venv/bin/activate
(venv)$ pip install poetry
(venv)$ poetry install
</code></pre>
<h2 id="docker-image"><a class="header" href="#docker-image">Docker image</a></h2>
<p>A prebuilt image can be found on <code>ghcr.io/pblottiere/qsa</code>:</p>
<pre><code class="language-console">$ docker pull ghcr.io/pblottiere/qsa:1.1.0
</code></pre>
<p>Otherwise the image can manually be built using:
<code>docker build -t my-custom-qsa-image .</code>. See <a href="qsa-api/../sandbox/index.html">Sandbox</a>
for details how to use it.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="qsa-rest-api--configuration"><a class="header" href="#qsa-rest-api--configuration">QSA REST API : configuration</a></h1>
<p>QSA web server can be configured thanks to the next environment variables:</p>
<div class="table-wrapper"><table><thead><tr><th>Mandatory</th><th>Environment variable</th><th>Description</th></tr></thead><tbody>
<tr><td>Yes</td><td><code>QSA_QGISSERVER_URL</code></td><td>QGIS Server URL</td></tr>
<tr><td>Yes</td><td><code>QSA_QGISSERVER_PROJECTS_DIR</code></td><td>Storage location on the filesystem for QGIS projects/styles and QSA database</td></tr>
<tr><td>No</td><td><code>QSA_LOGLEVEL</code></td><td>Loglevel : DEBUG, INFO (default) or ERROR</td></tr>
<tr><td>No</td><td><code>QSA_QGISSERVER_PROJECTS_PSQL_SERVICE</code></td><td>PostgreSQL service to store QGIS projects</td></tr>
<tr><td>No</td><td><code>QSA_QGISSERVER_MONITORING_PORT</code></td><td>Connection port for <code>qsa-plugin</code></td></tr>
<tr><td>No</td><td><code>QSA_MAPPROXY_PROJECTS_DIR</code></td><td>Storage location on the filesystem for MapProxy configuration files</td></tr>
<tr><td>No</td><td><code>QSA_MAPPROXY_CACHE_S3_BUCKET</code></td><td>Activate S3 cache for MapProxy if bucket is set</td></tr>
<tr><td>No</td><td><code>QSA_MAPPROXY_CACHE_S3_DIR</code></td><td>S3 cache directory for MapProxy. Default to <code>/mapproxy/cache</code></td></tr>
</tbody></table>
</div><div class="warning">
MapProxy
<p>Time dimension caching is not supported with S3 backend storage.</p>
</div>
<h2 id="postgresql-support"><a class="header" href="#postgresql-support">PostgreSQL support</a></h2>
<p>When PostgreSQL support is enabled to store QGIS projects thanks to the
<code>QSA_QGISSERVER_PROJECTS_PSQL_SERVICE</code> environment variable, the directory
<code>QSA_QGISSERVER_PROJECTS_DIR</code> is only used to store the QSA SQLite database as
well as QGIS QML styles.</p>
<p>The PostgreSQL support relies on a <code>service</code> defined in a <a href="https://www.postgresql.org/docs/current/libpq-pgservice.html">PostgreSQL connection
service file</a>.</p>
<p>For example with <code>QSA_QGISSERVER_PROJECTS_PSQL_SERVICE=qsa_projects</code>, a proper
<code>qsa_projects</code> section is needed in <code>~/.pg_service.conf</code>:</p>
<pre><code class="language-conf">[qsa_projects]
host=localhost
port=5432
dbname=qsa_test
user=pblottiere
password=
</code></pre>
<p>A query string parameter can be used to specify a <code>schema</code> through the QSA API
(<code>public</code> is used by default).</p>
<div class="warning">
Roadmap
<p>In the future, the QSA database and QGIS styles will also be stored in
PostgreSQL when enabled.</p>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="qsa-rest-api--endpoints"><a class="header" href="#qsa-rest-api--endpoints">QSA REST API : endpoints</a></h1>
<p>The QSA REST API provides several endpoints:</p>
<ul>
<li><a href="qsa-api/endpoints/symbology.html">/api/symbology</a></li>
<li><a href="qsa-api/endpoints/projects.html">/api/projects</a></li>
<li><a href="qsa-api/endpoints/instances.html">/api/instances</a></li>
<li><a href="qsa-api/endpoints/processing.html">/api/processing</a></li>
</ul>
<h2 id="postgresql-schema"><a class="header" href="#postgresql-schema">PostgreSQL schema</a></h2>
<p>When PostgreSQL support is enabled, a query string parameter <code>schema</code> may be
used to specify the schema in which the QGIS project is stored in the database
(<code>public</code> is used by default).</p>
<pre><code class="language-console"># call a specific endpoint using projects stored in PostgreSQL schema named `myschema`
$ curl "http://localhost/api/xxx/yyy?schema=myschema"
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="qsa-rest-api--apisymbology"><a class="header" href="#qsa-rest-api--apisymbology">QSA REST API : /api/symbology</a></h1>
<p>Vector layers rendering can be configured with several kinds of symbols
according to the geometry type. The <a href="https://docs.qgis.org/3.34/en/docs/user_manual/style_library/symbol_selector.html">symbol selector</a>
in QGIS is very dense but for now, only <code>Marker</code>, <code>Line</code> and <code>Fill</code> simple
symbols are supported.</p>
<p>The <code>/api/symbology</code> endpoint allows to dynamically retrieve the corresponding
parameters as well as raster renderer properties depending on QGIS Server
version.</p>
<div class="table-wrapper"><table><thead><tr><th>Method</th><th>URL</th><th>Description</th></tr></thead><tbody>
<tr><td>GET</td><td><code>/api/symbology/vector/point/single_symbol/marker/properties</code></td><td>Marker simple symbol properties</td></tr>
<tr><td>GET</td><td><code>/api/symbology/vector/line/single_symbol/line/properties</code></td><td>Line simple symbol properties</td></tr>
<tr><td>GET</td><td><code>/api/symbology/vector/polygon/single_symbol/fill/properties</code></td><td>Polygon simple symbol properties</td></tr>
<tr><td>GET</td><td><code>/api/symbology/vector/rendering/properties</code></td><td>Vector layer rendering properties</td></tr>
<tr><td>GET</td><td><code>/api/symbology/raster/singlebandgray/properties</code></td><td>Single band gray properties</td></tr>
<tr><td>GET</td><td><code>/api/symbology/raster/multibandcolor/properties</code></td><td>Multi band color properties</td></tr>
<tr><td>GET</td><td><code>/api/symbology/raster/singlebandpseudocolor/properties</code></td><td>Single band pseudocolor properties</td></tr>
<tr><td>GET</td><td><code>/api/symbology/raster/singlebandpseudocolor/ramp/{name}/properties</code></td><td>Single band pseudocolor ramp properties</td></tr>
<tr><td>GET</td><td><code>/api/symbology/raster/rendering/properties</code></td><td>Raster layer rendering properties</td></tr>
</tbody></table>
</div>
<p>Examples:</p>
<pre><code class="language-console"># Return single symbol properties for polygon layers
$ curl "http://localhost:5000/api/symbology/vector/polygon/single_symbol/fill/properties" | jq
{
  "border_width_map_unit_scale": "3x:0,0,0,0,0,0",
  "color": "0,0,255,255",
  "joinstyle": "bevel",
  "offset": "0,0",
  "offset_map_unit_scale": "3x:0,0,0,0,0,0",
  "offset_unit": "MM",
  "outline_color": "35,35,35,255",
  "outline_style": "solid (no, solid, dash, dot, dash dot, dash dot dot)",
  "outline_width": "0.26",
  "outline_width_unit": "MM",
  "style": "solid"
}

# Return multi band gray properties for raster layers
$ curl "http://localhost:5000/api/symbology/raster/multibandcolor/properties" | jq
{
  "blue": {
    "band": 3,
    "min": 0.0,
    "max": 1.0
  },
  "green": {
    "band": 2,
    "min": 0.0,
    "max": 1.0
  },
  "red": {
    "band": 1,
    "min": 0.0,
    "max": 1.0
  }
  "contrast_enhancement": {
    "algorithm": "StretchToMinimumMaximum (StretchToMinimumMaximum, NoEnhancement)",
    "limits_min_max": "MinMax (MinMax, UserDefined)"
  }
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="qsa-rest-api--apiprojects"><a class="header" href="#qsa-rest-api--apiprojects">QSA REST API : /api/projects</a></h1>
<h2 id="project"><a class="header" href="#project">Project</a></h2>
<p>A QSA project is defined by:</p>
<ul>
<li>a QGIS project</li>
<li>a list of themes</li>
<li>an internal SQLite database</li>
<li>a MapProxy configuration file (if enabled)</li>
</ul>
<div class="table-wrapper"><table><thead><tr><th>Method</th><th>URL</th><th>Description</th></tr></thead><tbody>
<tr><td>GET</td><td><code>/api/projects</code></td><td>List projects</td></tr>
<tr><td>GET</td><td><code>/api/projects/{project}</code></td><td>List project’s metadata</td></tr>
<tr><td>POST</td><td><code>/api/projects/</code></td><td>Create a project with <code>name</code>, <code>author</code> and <code>schema</code> (only used when PostgreSQL support is enabled)</td></tr>
<tr><td>DELETE</td><td><code>/api/projects/{project}</code></td><td>Remove a project</td></tr>
</tbody></table>
</div>
<p>Examples:</p>
<pre><code class="language-console"># create a project and store the QGIS project in PostgreSQL within `my_schema`
$ curl "http://localhost/api/projects/" \
     -X POST \
     -H 'Content-Type: application/json' \
     -d '{
        "name":"my_project",
        "author":"pblottiere",
        "schema":"my_schema"
     }'

# get metadata about the project stored in PostgreSQL
$ curl "http://localhost/api/projects/my_project?schema=my_schema"
</code></pre>
<h2 id="layer"><a class="header" href="#layer">Layer</a></h2>
<p>When a layer is added/removed to a QSA project, the corresponding QGIS project
is updated. When MapProxy cache management is enabled, the configuration file is
updated as well and the cache may be cleaned if necessary (for example when the
current style is updated).</p>
<p>Several themes can be associated with a layer like in QGIS Desktop, but only
the current one is used when the <code>STYLE</code> parameter in OGC web services is
empty.</p>
<div class="table-wrapper"><table><thead><tr><th>Method</th><th>URL</th><th>Description</th></tr></thead><tbody>
<tr><td>GET</td><td><code>/api/projects/{project}/layers</code></td><td>List layers in project</td></tr>
<tr><td>GET</td><td><code>/api/projects/{project}/layers/{layer}</code></td><td>List layer’s metadata</td></tr>
<tr><td>GET</td><td><code>/api/projects/{project}/layers/{layer}/map</code></td><td>WMS <code>GetMap</code> result with default parameters</td></tr>
<tr><td>GET</td><td><code>/api/projects/{project}/layers/{layer}/map/url</code></td><td>WMS <code>GetMap</code> URL with default parameters</td></tr>
<tr><td>POST</td><td><code>/api/projects/{project}/layers</code></td><td>Add layer to project. See <a href="qsa-api/endpoints/projects.html#layer-definition">Layer definition</a> for more information.</td></tr>
<tr><td>POST</td><td><code>/api/projects/{project}/layers/{layer}/style</code></td><td>Add/Update layer’s style with <code>name</code> (style name) and <code>current</code> (<code>true</code> or <code>false</code>)</td></tr>
<tr><td>DELETE</td><td><code>/api/projects/{project}/layers/{layer}</code></td><td>Remove layer from project</td></tr>
</tbody></table>
</div>
<h3 id="layer-definition"><a class="header" href="#layer-definition">Layer definition</a></h3>
<p>A layer can be added to a project thanks to the next parameters:</p>
<ul>
<li><code>type</code> : <code>raster</code> or <code>vector</code></li>
<li><code>name</code> : the layer’s name</li>
<li><code>datasource</code> : the link to the datasource according to the storage backend
<ul>
<li>filesystem : <code>/tmp/raster.tif</code></li>
<li>AWS S3 : <code>/vsis3/bucket/raster.tif</code></li>
<li>PostGIS : <code>service=qsa table=\"public\".\"lines\" (geom)</code></li>
</ul>
</li>
<li><code>overview</code> (optional) : automatically build overviews for raster layers stored in S3 buckets</li>
<li><code>crs</code> (optional) : CRS (automatically detected by default)</li>
</ul>
<p>Example:</p>
<pre><code class="language-console"># Add a FlatGeobuf vector layer stored on S3 bucket in project `my_project`
$ curl "http://localhost/api/projects/my_project/layers" \
  -X POST \
  -H 'Content-Type: application/json' \
  -d '{
    "name":"my_layer",
    "type":"vector",
    "datasource":"/vsis3/my-storage/vector/my_layer.fgb"
  }'
</code></pre>
<h2 id="style"><a class="header" href="#style">Style</a></h2>
<p>A QSA style may be used through the <code>STYLE</code> OGC web services parameter to
specify the rendering for a specific layer. Default styles may be defined and
automatically used when a vector layer is added to a QSA project.</p>
<div class="table-wrapper"><table><thead><tr><th>Method</th><th>URL</th><th>Description</th></tr></thead><tbody>
<tr><td>GET</td><td><code>/api/projects/{project}/styles</code></td><td>List styles in project</td></tr>
<tr><td>GET</td><td><code>/api/projects/{project}/styles/default</code></td><td>List default styles in project</td></tr>
<tr><td>GET</td><td><code>/api/projects/{project}/styles/{style}</code></td><td>List style’s metadata</td></tr>
<tr><td>POST</td><td><code>/api/projects/{project}/styles/{style}</code></td><td>Add style to project. See <a href="qsa-api/endpoints/projects.html#vector-style">Vector style</a> and <a href="qsa-api/endpoints/projects.html#raster-style">Raster style</a> for more information.</td></tr>
<tr><td>POST</td><td><code>/api/projects/{project}/styles/default</code></td><td>Set a default layer’s style. See <a href="qsa-api/endpoints/projects.html#vector-style">Vector style</a> and <a href="qsa-api/endpoints/projects.html#raster-style">Raster style</a> for more information.</td></tr>
<tr><td>DELETE</td><td><code>/api/projects/{project}/styles/{style}</code></td><td>Remove style from project</td></tr>
</tbody></table>
</div>
<h3 id="vector-style"><a class="header" href="#vector-style">Vector style</a></h3>
<p>For vector layers, a style can be defined with the parameters listed below:</p>
<ul>
<li><code>type</code> : <code>vector</code></li>
<li><code>name</code> : the name of the style</li>
<li><code>rendering</code> : rendering parameters (only <code>opacity</code> is supported for now)</li>
<li><code>symbology</code> : dictionary with <code>type</code> (only <code>single_symbol</code> is supported for
now), <code>symbol</code> and <code>properties</code></li>
</ul>
<p>Example:</p>
<pre><code class="language-console"># Add a style for point geometry vector layers
$ curl "http://localhost:5000/api/projects/my_project/styles" \
  -X POST \
  -H 'Content-Type: application/json' \
  -d '{
    "type": "vector",
    "name": "my_marker_style",
    "rendering": {
      "opacity": 100.
    },
    "symbology": {
      "type": "single_symbol",
      "symbol": "marker",
      "properties": {
        "color": "#112233"
      }
    }
  }'
</code></pre>
<p>To set a default style for a specific geometry, the parameters listed below are available:</p>
<ul>
<li><code>name</code> : the name of the style to use by default</li>
<li><code>geometry</code> : the geometry for which the style needs to be applied</li>
</ul>
<h4 id="raster-style"><a class="header" href="#raster-style">Raster style</a></h4>
<p>For raster layers, a style can be defined with the parameters listed below:</p>
<ul>
<li><code>type</code> : <code>raster</code></li>
<li><code>name</code> : the name of the style</li>
<li><code>rendering</code> : rendering parameters</li>
<li><code>symbology</code> : dictionary with <code>type</code> (only <code>singlebandgray</code> and
<code>multibandcolor</code> are supported for now) and <code>properties</code></li>
</ul>
<p>Example:</p>
<pre><code class="language-console"># Add a style for multiband raster
$ curl "http://localhost:5000/api/projects/my_project/styles" \
  -X POST \
  -H 'Content-Type: application/json' \
  -d '{
    "type": "raster",
    "name": "my_multiband_style",
    "rendering": {
      "saturation": 3,
      "brightness": -148,
      "contrast": 42,
      "gamma": 4.
    },
    "symbology": {
      "type": "multibandcolor",
      "properties": {
        "red": {
          "band": 1
        },
        "green": {
          "band": 2
        },
        "blue": {
          "band": 3
        }
      }
    }
  }'
</code></pre>
<h2 id="cache"><a class="header" href="#cache">Cache</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Method</th><th>URL</th><th>Description</th></tr></thead><tbody>
<tr><td>GET</td><td><code>/api/projects/{project}/cache</code></td><td>Return metadata about the cache</td></tr>
<tr><td>POST</td><td><code>/api/projects/{project}/cache/reset</code></td><td>Clear cached data and reset cache configuration</td></tr>
</tbody></table>
</div>
<p>Example:</p>
<pre><code class="language-console">$ curl "http://localhost:5000/api/projects/my_project/cache"
{
  "valid":true,
  "storage":"filesystem"
}
</code></pre>
<div class="warning">
Reset cache
<p>When a QGIS project is created manually without QSA, the cache is not
initialized. This method allows to create the MapProxy configuration file
accordingly.</p>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="qsa-rest-api--apiprocessing"><a class="header" href="#qsa-rest-api--apiprocessing">QSA REST API : /api/processing</a></h1>
<p>The QSA REST API provides some basic processing methods to create on-the-fly
rasters or get histogram for raster layers.</p>
<div class="table-wrapper"><table><thead><tr><th>Method</th><th>URL</th><th>Description</th></tr></thead><tbody>
<tr><td>POST</td><td><code>/api/processing/raster/histogram/{project}/{layer}</code></td><td>Return an histogram in JSON</td></tr>
<tr><td>POST</td><td><code>/api/processing/raster/calculator/{project}</code></td><td>Create a raster based on an <code>expression</code> and an <code>output</code> filename</td></tr>
</tbody></table>
</div>
<p>Examples:</p>
<pre><code class="language-console"># create a new layer based on a QGIS expression
$ curl "http://localhost/api/projects/" \
     -X POST \
     -H 'Content-Type: application/json' \
     -d '{
        "expression":"layer@1 + 10",
        "output":"/vsis3/my-storage/result.tif"
     }'
</code></pre>
<div class="warning">
Processing
<p>These are basic processing methods but one could argue that WPS or OGC API
Processes should be used instead.</p>
</div>
<div style="break-before: page; page-break-before: always;"></div><h1 id="qsa-rest-api--apiinstances"><a class="header" href="#qsa-rest-api--apiinstances">QSA REST API : /api/instances</a></h1>
<p>When <code>qsa-plugin</code> is installed, an <code>/api/instances</code> endpoint is available to
retrieve information about QGIS Server underlying instances.</p>
<div class="table-wrapper"><table><thead><tr><th>Method</th><th>URL</th><th>Description</th></tr></thead><tbody>
<tr><td>GET</td><td><code>/api/instances</code></td><td>List online QGIS Server instances</td></tr>
<tr><td>GET</td><td><code>/api/instances/{instance}</code></td><td>List QGIS Server instance metadata</td></tr>
<tr><td>GET</td><td><code>/api/instances/{instance}/logs</code></td><td>Return logs of QGIS Server instance</td></tr>
<tr><td>GET</td><td><code>/api/instances/{instance}/stats</code></td><td>Return stats of QGIS Server instance</td></tr>
</tbody></table>
</div><div style="break-before: page; page-break-before: always;"></div><h1 id="qsa-plugin"><a class="header" href="#qsa-plugin">QSA plugin</a></h1>
<p><a href="https://docs.qgis.org/3.34/en/docs/server_manual/plugins.html">Python QGIS server plugin</a>
which starts a dedicated thread with a TCP autoregistering client.</p>
<p>Features:</p>
<ul>
<li>Return metadata, logs, … about QGIS Server without interfering with the rendering loop</li>
<li>TODO : Influence the QGIS Server behavior through communication with the main thread</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="qsa-plugin--installation"><a class="header" href="#qsa-plugin--installation">QSA plugin : installation</a></h1>
<p>Installation of QGIS Server’s plugins is documented in the official
<a href="https://docs.qgis.org/3.34/en/docs/server_manual/plugins.html">QGIS Server Guide</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="qsa-plugin--configuration"><a class="header" href="#qsa-plugin--configuration">QSA plugin : configuration</a></h1>
<p>The QSA plugin can be configured thanks to the next environment variables:</p>
<div class="table-wrapper"><table><thead><tr><th>Mandatory</th><th>Environment variable</th><th>Description</th></tr></thead><tbody>
<tr><td>Yes</td><td><code>QSA_HOST</code></td><td>QSA REST API host</td></tr>
<tr><td>Yes</td><td><code>QSA_PORT</code></td><td>QSA REST API port</td></tr>
</tbody></table>
</div><div style="break-before: page; page-break-before: always;"></div><h1 id="qsa-plugin--usage"><a class="header" href="#qsa-plugin--usage">QSA plugin : usage</a></h1>
<p>The QSA plugin starts a TCP socket and tries to connect to the QSA REST API
server every 5 seconds. The next messages are written in QGIS Server logs
during the connection phase:</p>
<pre><code class="language-console">Try to connect...
Try to connect...
Try to connect...
Connected with QSA server
</code></pre>
<p>As soon as the plugin is connected to the QSA Server, you don’t need to worry
about anything else.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="qsa-cli"><a class="header" href="#qsa-cli">QSA cli</a></h1>
<p>Command line application dedicated to manage QGIS Server instances through the
QSA REST API.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="qsa-cli--installation"><a class="header" href="#qsa-cli--installation">QSA cli : installation</a></h1>
<p>From sources:</p>
<pre><code class="language-console">$ cd qsa-cli
$ virtualenv venv
$ . venv/bin/activate
(venv)$ pip install poetry
(venv)$ poetry install
</code></pre>
<p>Binary distributions:</p>
<p>TODO : provide a package on PyPI</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="qsa-cli--configuration"><a class="header" href="#qsa-cli--configuration">QSA cli : configuration</a></h1>
<p>The QSA cli tool can be configured thanks to the next environment variable:</p>
<div class="table-wrapper"><table><thead><tr><th>Mandatory</th><th>Environment variable</th><th>Description</th></tr></thead><tbody>
<tr><td>Yes</td><td><code>QSA_SERVER_URL</code></td><td>QSA REST API server URL</td></tr>
</tbody></table>
</div><div style="break-before: page; page-break-before: always;"></div><h1 id="qsa-cli--commands"><a class="header" href="#qsa-cli--commands">QSA cli : commands</a></h1>
<p>Command’s names are inspired by <code>Docker</code>:</p>
<pre><code class="language-console">$ qsa --help
Usage: qsa [OPTIONS] COMMAND [ARGS]...

Options:
  --help  Show this message and exit.

Commands:
  inspect  Returns metadata about a specific QGIS Server instance
  logs     Returns logs of a specific QGIS Server instance
  ps       List QGIS Server instances
  stats    Returns stats of QGIS Server instances
</code></pre>
<p>Examples:</p>
<pre><code class="language-console">$ qsa ps
INSTANCE ID    IP          STATUS
-------------  ----------  -----------------------
336a0fc1       172.20.0.2  Binded 1315 seconds ago
13097056       172.20.0.4  Binded 1315 seconds ago
a523ee7a       172.20.0.5  Binded 1315 seconds ago
d11e11a4       172.20.0.6  Binded 1315 seconds ago
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="sandbox"><a class="header" href="#sandbox">Sandbox</a></h1>
<p>The sandbox directory provides a plug-and-play <code>Docker</code> environment to discover
QSA tools with PostgreSQL support enabled.</p>
<p>First, a QSA REST API server is set up with 4 QGIS Server instances:</p>
<pre><code class="language-console">$ cd sandbox
$ docker-compose up --scale qgisserver=4 -d
$ docker ps
CONTAINER ID   IMAGE                              COMMAND                  CREATED       STATUS         PORTS                                       NAMES
d2eaf6bdfae4   pblottiere/qsa          "gunicorn -b 0.0.0.0…"   2 hours ago   Up 10 seconds  0.0.0.0:5000-&gt;5000/tcp, :::5000-&gt;5000/tcp   sandbox-qsa-1
b47085d9ad65   postgis/postgis:15      "docker-entrypoint.s…"   5 days ago    Up 9 seconds   0.0.0.0:5433-&gt;5432/tcp, :::5433-&gt;5432/tcp   sandbox-postgres-1
77fa87641b42   qgis/qgis-server:3.38   "/bin/sh -c /usr/loc…"   2 hours ago   Up 9 seconds   80/tcp, 9993/tcp                            sandbox-qgisserver-1
093346c82ea8   qgis/qgis-server:3.38   "/bin/sh -c /usr/loc…"   2 hours ago   Up 9 seconds   80/tcp, 9993/tcp                            sandbox-qgisserver-2
afd95ccaef9e   qgis/qgis-server:3.38   "/bin/sh -c /usr/loc…"   2 hours ago   Up 9 seconds   80/tcp, 9993/tcp                            sandbox-qgisserver-3
0b13f3d867c5   qgis/qgis-server:3.38   "/bin/sh -c /usr/loc…"   2 hours ago   Up 8 seconds   80/tcp, 9993/tcp                            sandbox-qgisserver-4
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="sandbox--introspection"><a class="header" href="#sandbox--introspection">Sandbox : introspection</a></h1>
<p><code>qsa-cli</code> allows to inspect online QGIS Server instances registered to
<code>qsa-api</code> server, but it’s also possible to use the REST API.</p>
<h2 id="list-online-instances"><a class="header" href="#list-online-instances">List online instances</a></h2>
<p>To list these instances with <code>qsa-cli</code>:</p>
<pre><code class="language-console">$ QSA_SERVER_URL=http://localhost:5000 qsa ps
INSTANCE ID    IP          STATUS
-------------  ----------  -----------------------
6773ca08       172.20.0.2  Binded 1096 seconds ago
4464d3c5       172.20.0.4  Binded 1096 seconds ago
012083b9       172.20.0.5  Binded 1096 seconds ago
c0047e66       172.20.0.6  Binded 1096 seconds ago
</code></pre>
<p>Or with the API:</p>
<pre><code class="language-console">$ curl http://localhost:5000/api/instances/ | jq
{
  "servers": [
    {
      "binded": 1217,
      "id": "6773ca08",
      "ip": "172.20.0.2"
    },
    {
      "binded": 1217,
      "id": "4464d3c5",
      "ip": "172.20.0.4"
    },
    {
      "binded": 1217,
      "id": "012083b9",
      "ip": "172.20.0.5"
    },
    {
      "binded": 1217,
      "id": "c0047e66",
      "ip": "172.20.0.6"
    }
  ]
}
</code></pre>
<h2 id="get-metadata"><a class="header" href="#get-metadata">Get metadata</a></h2>
<p>To get some metadata about a specific QGIS Server instance with <code>qsa-cli</code>:</p>
<pre><code class="language-console">$ qsa inspect 4464d3c5
{
  "cache": {
    "projects": []
  },
  "plugins": [
    "qsa"
  ],
  "providers": [
    "OGC API - Features data provider",
    "WFS data provider",
    "ArcGIS Feature Service data provider",
    "ArcGIS Map Service data provider",
    "COPC point cloud data provider",
    "Delimited text data provider",
    "EPT point cloud data provider",
    "GDAL data provider",
    "GPS eXchange format provider",
    "SAP HANA spatial data provider",
    "MDAL provider",
    "Memory provider",
    "Mesh memory provider",
    "MSSQL spatial data provider",
    "OGR data provider",
    "PDAL point cloud data provider",
    "PostgreSQL/PostGIS data provider",
    "Postgres raster provider",
    "SpatiaLite data provider",
    "Vector tile provider",
    "Virtual layer data provider",
    "Virtual Raster data provider",
    "OGC Web Coverage Service version 1.0/1.1 data provider",
    "OGC Web Map Service version 1.3 data provider",
    ""
  ],
  "versions": {
    "gdal": "3.4.1",
    "python": "3.10.6",
    "qgis": "3.30.3",
    "qt": "5.15.3"
  }
}
</code></pre>
<p>Or with the API <code>curl http://localhost:5000/api/instances/4464d3c5</code>.</p>
<h2 id="fetch-the-log"><a class="header" href="#fetch-the-log">Fetch the log</a></h2>
<p>A bad request to QGIS Server to have something in the log:</p>
<pre><code class="language-console">$ curl http://172.20.0.4/ogc/
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;ServerException&gt;Project file error. For OWS services: please provide a SERVICE and a MAP parameter pointing to a valid QGIS project file&lt;/ServerException&gt;
</code></pre>
<p>Then to fetch the log of the corresponding QGIS Server instance with <code>qsa-cli</code>:</p>
<pre><code class="language-console">$ qsa logs 4464d3c5
Server plugin qsa loaded!
Server python plugins loaded
******************** New request ***************
Request URL: http://172.20.0.4/ogc/?map=/io/data//.qgs
Environment:
------------------------------------------------
SERVER_NAME: 172.20.0.4
REQUEST_URI: /ogc/
SCRIPT_NAME: /qgis/qgis_mapserv.fcgi
HTTPS:
REMOTE_ADDR: 172.20.0.1
SERVER_PORT: 80
QUERY_STRING: map=/io/data//.qgs
REMOTE_USER:
CONTENT_TYPE:
REQUEST_METHOD: GET
SERVER_PROTOCOL: HTTP/1.1
MAP:/io/data//.qgs
Error when loading project file '/io/data//.qgs': Unable to open /io/data//.qgs
Trying URL path: '/ogc/' for '/'
Trying URL path: '/ogc/' for '/wfs3'
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;ServerException&gt;Project file error. For OWS services: please provide a SERVICE and a MAP parameter pointing to a valid QGIS project file&lt;/ServerException&gt;

Request finished in 3 ms
</code></pre>
<h2 id="display-stats"><a class="header" href="#display-stats">Display stats</a></h2>
<p>To display stats for all QGIS Server online instances:</p>
<pre><code class="language-console">$ qsa stats
INSTANCE ID      COUNT  TIME        SERVICE    REQUEST    PROJECT
-------------  -------  ----------  ---------  ---------  ---------
4464d3c5             1
6773ca08             0
012083b9             0
c0047e66             0
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="sandbox--projects"><a class="header" href="#sandbox--projects">Sandbox : projects</a></h1>
<h2 id="create-and-delete-projects-in-postgresql"><a class="header" href="#create-and-delete-projects-in-postgresql">Create and delete projects in PostgreSQL</a></h2>
<p>First we create a schema to store QGIS projects:</p>
<pre><code class="language-console">$ psql -h localhost -p 5433 -U qsa qsa -c "create schema my_schema"
CREATE SCHEMA
</code></pre>
<p>Then we create a QSA project:</p>
<pre><code class="language-console">$ curl "http://localhost:5000/api/projects/" \
    -X POST \
    -H 'Content-Type: application/json' \
    -d '{
        "name":"my_project",
        "author":"pblottiere",
        "schema":"my_schema"
    }'
</code></pre>
<p>In this case, a directory has been created on the filesystem with the internal
QSA database:</p>
<pre><code class="language-console">$ file projects/qsa/my_schema_my_project/qsa.db
SQLite 3.x database
</code></pre>
<p>And a QGIS project has been created in PostgreSQL:</p>
<pre><code class="language-console">$ psql -h localhost -p 5433 -U qsa qsa -c "select name from my_schema.qgis_projects"
    name
------------
 my_project
(1 row)
</code></pre>
<p>To create another project in <code>public</code> schema and list available projects thanks
to the QSA API:</p>
<pre><code class="language-console">$ curl "http://localhost:5000/api/projects/" \
    -X POST \
    -H 'Content-Type: application/json' \
    -d '{
        "name":"my_project_2",
        "author":"pblottiere"
    }'
true
$ curl "http://localhost:5000/api/projects/"
["my_project_2"]
$ curl "http://localhost:5000/api/projects/?schema=my_schema"
["my_project"]
</code></pre>
<p>To delete a project:</p>
<pre><code class="language-console">$ curl -X DELETE "http://localhost:5000/api/projects/my_project_2"
true
$ curl "http://localhost:5000/api/projects/"
[]
</code></pre>
<p>To list project metadata:</p>
<pre><code class="language-console">$ curl http://localhost:5000/api/projects/my_project?schema=my_schema | jq
{
  "author": "pblottiere",
  "creation_datetime": "2024-03-14T20:17:45",
  "crs": "EPSG:3857",
  "schema": "my_schema",
  "storage": "postgresql"
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="vector"><a class="header" href="#vector">Vector</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="sandbox--vector-layers"><a class="header" href="#sandbox--vector-layers">Sandbox : vector layers</a></h1>
<p>Layers are based on the <code>data.gpkg</code> file mounted in the Docker containers.</p>
<h2 id="add-layers"><a class="header" href="#add-layers">Add layers</a></h2>
<p>To add a polygon layer from a geopackage to a project:</p>
<pre><code class="language-console">$ curl "http://localhost:5000/api/projects/my_project/layers?schema=my_schema" \
  -X POST \
  -H 'Content-Type: application/json' \
  -d '{
    "crs": 4326,
    "datasource":"/data.gpkg|layername=polygons",
    "name":"polygons",
    "type":"vector"
  }'
</code></pre>
<p>And a line layer from PostGIS:</p>
<pre><code class="language-console"># copy geopackage table to PostGIS
$ ogr2ogr -f PostgreSQL "PG:dbname=qsa password=qsa user=qsa port=5433 host=localhost" data.gpkg lines

# add a line layer based on the PostGIS table
$ curl "http://localhost:5000/api/projects/my_project/layers?schema=my_schema" \
  -X POST \
  -H 'Content-Type: application/json' \
  -d '{
    "crs": 4326,
    "datasource":"service=qsa table=\"public\".\"lines\" (geom)",
    "name":"lines",
    "type":"vector"
  }'
</code></pre>
<h2 id="list-layers-and-get-metadata"><a class="header" href="#list-layers-and-get-metadata">List layers and get metadata</a></h2>
<pre><code class="language-console">$ curl "http://localhost:5000/api/projects/my_project/layers?schema=my_schema"
["lines","polygons"]
</code></pre>
<pre><code class="language-console">$ curl "http://localhost:5000/api/projects/my_project/layers/lines?schema=my_schema" | jq
{
  "bbox": "-117.62319839219100004 23.20820580488510032, -82.32264950769270229 46.18290982947510059",
  "crs": "EPSG:4326",
  "current_style": "default",
  "geometry": "MultiLineString",
  "name": "lines",
  "source": "service='qsa' key='fid' checkPrimaryKeyUnicity='1' table=\"public\".\"lines\" (geom)",
  "styles": [
    "default"
  ],
  "type": "vector",
  "valid": true
}
</code></pre>
<h2 id="map-sample"><a class="header" href="#map-sample">Map sample</a></h2>
<p>To execute a WMS <code>GetMap</code> request with basic parameters:</p>
<pre><code class="language-console">$ curl "http://localhost:5000/api/projects/my_project/layers/polygons/map?schema=my_schema" --output map.png
</code></pre>
<img src="sandbox/vector/../../images/map.png" width="300">
<h2 id="delete-layers"><a class="header" href="#delete-layers">Delete layers</a></h2>
<pre><code class="language-console">$ curl -X DELETE "http://localhost:5000/api/projects/my_project/layers/lines?schema=my_schema"

$ curl "http://localhost:5000/api/projects/my_project/layers?schema=my_schema"
["polygons"]
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="sandbox--vector-styles"><a class="header" href="#sandbox--vector-styles">Sandbox : vector styles</a></h1>
<h2 id="add-style-to-project"><a class="header" href="#add-style-to-project">Add style to project</a></h2>
<p>To list available properties for the polygon single symbol renderer:</p>
<pre><code class="language-console">$ curl "http://localhost:5000/api/symbology/vector/polygon/single_symbol/fill/properties" | jq
{
  "border_width_map_unit_scale": "3x:0,0,0,0,0,0",
  "color": "0,0,255,255",
  "joinstyle": "bevel",
  "offset": "0,0",
  "offset_map_unit_scale": "3x:0,0,0,0,0,0",
  "offset_unit": "MM",
  "outline_color": "35,35,35,255",
  "outline_style": "solid (no, solid, dash, dot, dash dot, dash dot dot)",
  "outline_width": "0.26",
  "outline_width_unit": "MM",
  "style": "solid"
}
</code></pre>
<p>To add a style for a polygon layer:</p>
<pre><code class="language-console">$ curl "http://localhost:5000/api/projects/my_project/styles?schema=my_schema" \
  -X POST \
  -H 'Content-Type: application/json' \
  -d '{
    "type": "vector",
    "name": "my_fill_style",
    "symbology": {
      "type": "single_symbol",
      "symbol": "fill",
      "properties": {
          "color": "#00BBBB",
          "style": "cross",
          "outline_width": 0.16,
          "outline_color": "#002222"
      }
    },
    "rendering": {}
  }'
</code></pre>
<p>To list styles for a specific project:</p>
<pre><code class="language-console">$ curl "http://localhost:5000/api/projects/my_project/styles?schema=my_schema"
["my_fill_style"]
</code></pre>
<h2 id="apply-style-to-layer"><a class="header" href="#apply-style-to-layer">Apply style to layer</a></h2>
<p>To apply a specific style to a layer:</p>
<pre><code class="language-console">$ curl "http://localhost:5000/api/projects/my_project/layers/polygons/style?schema=my_schema" \
  -X POST \
  -H 'Content-Type: application/json' \
  -d '{
    "name":"my_fill_style",
    "current":true
  }'
</code></pre>
<p>The layer rendering has changed now:</p>
<pre><code class="language-console">$ curl "http://localhost:5000/api/projects/my_project/layers/polygons/map?schema=my_schema" --output map.png
</code></pre>
<img src="sandbox/vector/../../images/map_style.png" width="300">
<div style="break-before: page; page-break-before: always;"></div><h1 id="raster"><a class="header" href="#raster">Raster</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="sandbox--raster-layers"><a class="header" href="#sandbox--raster-layers">Sandbox : raster layers</a></h1>
<p>Layer is based on the <code>landsat_4326.tif</code> file mounted in the Docker containers.</p>
<h2 id="add-layers-1"><a class="header" href="#add-layers-1">Add layers</a></h2>
<p>To add a raster layer to a project:</p>
<pre><code class="language-console">$ curl "http://localhost:5000/api/projects/my_project/layers?schema=my_schema" \
  -X POST \
  -H 'Content-Type: application/json' \
  -d '{
    "datasource":"/dem.tif",
    "name":"dem",
    "type":"raster"
  }'
</code></pre>
<h2 id="list-layers-and-get-metadata-1"><a class="header" href="#list-layers-and-get-metadata-1">List layers and get metadata</a></h2>
<pre><code class="language-console"># list layers
$ curl "http://localhost:5000/api/projects/my_project/layers?schema=my_schema"
["polygons","dem"]

# get metadata
$ curl "http://localhost:5000/api/projects/my_project/layers/dem?schema=my_schema"
{
  "bands": 1,
  "bbox": "18.6662979442000001 45.77670143760000343, 18.70359794419999844 45.81170143760000002",
  "crs": "EPSG:4326",
  "current_style": "default",
  "data_type": "float32",
  "name": "dem",
  "source": "/dem.tif",
  "styles": [
    "default"
  ],
  "type": "raster",
  "valid": true
}
</code></pre>
<h2 id="map-sample-1"><a class="header" href="#map-sample-1">Map sample</a></h2>
<p>To execute a WMS <code>GetMap</code> request with basic parameters:</p>
<pre><code class="language-console">$ curl "http://localhost:5000/api/projects/my_project/layers/dem/map?schema=my_schema" --output map.png
</code></pre>
<img src="sandbox/raster/../../images/raster_dem_map.png" width="300">
<div style="break-before: page; page-break-before: always;"></div><h1 id="sandbox--raster-styles"><a class="header" href="#sandbox--raster-styles">Sandbox : raster styles</a></h1>
<h2 id="add-style-to-project-1"><a class="header" href="#add-style-to-project-1">Add style to project</a></h2>
<p>To add a style for a multiband raster layer:</p>
<pre><code class="language-console">$ curl "http://localhost:5000/api/projects/my_project/styles?schema=my_schema" \
  -X POST \
  -H 'Content-Type: application/json' \
  -d '{
    "type": "raster",
    "name": "my_singlebandgray_style",
    "symbology": {
      "type": "singlebandgray",
      "properties": {
        "gray": {
          "band": 1
        },
        "contrast_enhancement": {
          "algorithm": "StretchToMinimumMaximum",
          "limits_min_max": "MinMax"
        }
      }
    },
    "rendering": {
      "brightness": 255,
      "gamma": 0.1,
      "contrast": 100
    }
  }'
</code></pre>
<p>To list styles for a specific project:</p>
<pre><code class="language-console">$ curl "http://localhost:5000/api/projects/my_project/styles?schema=my_schema"
["my_singlebandgray_style"]
</code></pre>
<h2 id="apply-style-to-layer-1"><a class="header" href="#apply-style-to-layer-1">Apply style to layer</a></h2>
<p>To apply a specific style to a layer:</p>
<pre><code class="language-console">$ curl "http://localhost:5000/api/projects/my_project/layers/dem/style?schema=my_schema" \
  -X POST \
  -H 'Content-Type: application/json' \
  -d '{
    "name":"my_singlebandgray_style",
    "current":true
  }'
</code></pre>
<p>The layer rendering has changed now:</p>
<pre><code class="language-console">$ curl "http://localhost:5000/api/projects/my_project/layers/dem/map?schema=my_schema" --output map.png
</code></pre>
<img src="sandbox/raster/../../images/map_raster_style.png" width="300">
<div style="break-before: page; page-break-before: always;"></div><h1 id="sandbox--raster-processing"><a class="header" href="#sandbox--raster-processing">Sandbox : raster processing</a></h1>
<h2 id="histogram"><a class="header" href="#histogram">Histogram</a></h2>
<p>To get an histogram for a specific raster layer:</p>
<pre><code class="language-console">$ curl "http://localhost:5000/api/processing/raster/histogram/my_project/dem?schema=my_schema" \
  -X POST \
  -H 'Content-Type: application/json' \
  -d '{
    "min": 0,
    "count": 100
  }'
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="developers"><a class="header" href="#developers">Developers</a></h1>
<h2 id="documentation"><a class="header" href="#documentation">Documentation</a></h2>
<pre><code class="language-console">$ mdbook build docs
</code></pre>
<h2 id="unit-tests"><a class="header" href="#unit-tests">Unit tests</a></h2>
<p>Ensure you have a valid <code>qsa_test</code> section in <code>~/.pg_service.conf</code>:</p>
<pre><code class="language-conf">[qsa_test]
host=localhost
port=5432
dbname=qsa_test
user=myusername
password=
</code></pre>
<p>Run the tests with:</p>
<pre><code class="language-console">$ createdb qsa_test
$ cd qsa-api
$ pytest -sv tests
</code></pre>
<h2 id="integration-tests"><a class="header" href="#integration-tests">Integration tests</a></h2>
<pre><code class="language-console">$ cd sandbox
$ docker-compose up -d
$ cd ../qsa-api
$ QSA_GEOTIFF="/landsat_4326.tif" QSA_GPKG="/data.gpkg" QSA_HOST=127.0.01 QSA_PORT=5000 pytest -sv tests
</code></pre>
<h2 id="quality-tests"><a class="header" href="#quality-tests">Quality tests</a></h2>
<p>Ensure your changes are correctly formatted with <code>pre-commit</code> (see <a href="https://pre-commit.com/#installation">installation</a>):</p>
<pre><code class="language-console"># activate in repository
$ pre-commit install
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="funders"><a class="header" href="#funders">Funders</a></h1>
<a href="https://www.promethee.earth/en//" target="_blank">
  <img src="images/promethee.png" width="600">
</a>
<a href="https://hytech-imaging.fr/" target="_blank">
  <img src="images/hytech.png" width="600">
</a>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>

    </div>
    </body>
</html>
